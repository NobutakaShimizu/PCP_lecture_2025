\chapter{局所的な検証と弱いPCP定理の証明}

この章はPCP検証者における「少ないクエリ回数」という要件がなぜ達成できるかについて説明することを目的とする.
そのため, まずはPCP定理の要件であるランダムビットの短さはひとまず無視した以下の形の「弱いPCP定理」を証明する: 任意の$\NP$に属する判定問題が$O(1)$クエリかつ$\poly(n)$ビットのランダムネスを用いて確率的に検証可能である.

\section{局所的な検証}
本講義では, 検証者が証明の文字列$\pi$のうち$O(1)$個の文字を読み込んで検証を行うことを\emph{局所的な検証}と呼ぶことにする.
一般的な感覚として, ある主張が成り立つことを示す証明を検証する際, \emph{冗長に表現で記述しない限り}その証明を全て読み込まなければ検証できないと思われる (全ての文字に本質的な意味があるならば全てを確認しなければならないはずであろう).
では逆に, 証明を冗長に表現することで局所的な検証を可能にすることはできるだろうか?

\subsection{線形方程式の局所的な検証(1/2)}
興味深いことに, 非常に冗長性が大きい記述で証明が与えられたならば局所検証が可能であることを, 線形方程式の検証を例に説明する.

\begin{definition}{線形方程式}{linear-equation}
有限体$\F$上の行列$M\in\F^{m\times n}$とベクトル$z\in\F^m$に対して
\begin{align*}
  My = z
\end{align*}
を満たす$y\in\F^n$が存在するかどうかを判定する問題を$\LinEq$とする.
ここで$\abs{\F}=q$は$m,n$とは独立な定数であるとする (従って有限体上の演算は$O(1)$時間で計算できると仮定する).
\end{definition}

愚直な検証者として$y\in\F^n$を証拠として受け取り, $My=z$を確認することで検証を行うことを考える (実際の計算機では全てを二進文字列で表現するため, $\F$の元は$\ceil{\log_2\abs{\F}}=O(1)$ビットで表現されている).
明らかにこの検証者は$My$を計算するために$y$の全ての成分 (すなわち$O(n)$ビット) を読み込む必要があるため, 局所的な検証者とはならない.

ここで, 二つのベクトル$a,b\in\F^n$に対する次の性質を考える (証明は\cref{exer:random-inner-product}):
\begin{align}
  \Pr_{r\sim \F^n} \qty[ r^\top a \ne r^\top b ] = \begin{cases}
    0 & \text{if } a=b \\
    1-\frac{1}{q} & \text{if } a\ne b.
  \end{cases} \label{eq:linear-equation-property}
\end{align}
さて, \cref{eq:linear-equation-property}の性質を用いると一様ランダムな$r\sim\F^n$に対して
\begin{align}
  r^\top M y = r^\top z \label{eq:random-inner-product}
\end{align}
かどうかを確認することで, $My=z$かどうかを確率的に検証できる.
実際, $My=z$ならば確率$1$で検証者は受理し,
$My\ne z$ならば確率$1-1/q$で検証者は拒否する (何度も繰り返せばこの拒否率を任意に$1$に近い定数まで近づけることができる).
ベクトル$z$は入力として与えられているため\cref{eq:random-inner-product}の右辺は$O(n)$時間で計算できる.
一方で, ベクトル$y$は証拠として与えられるため, $r^\top M y$の計算は愚直に考えると$O(mn)$時間かかる上に$y$の全ての成分を読み込む必要がある.
ところが, 全てのベクトル$w\in \F^n$に対して$y^\top w\in\F$を連結して得られる長さ$q^n$の文字列$(y^\top w)_{w\in \F^n}$を証拠$\pi$として与えることにより,
自身で$r^\top M$を計算した後に $r^\top M y = y^\top (M^\top r)$の値を\emph{一文字の証拠の読み込み}で計算できるのである.

\begin{exercise}{ランダムなベクトルとの内積}{random-inner-product}
  \cref{eq:linear-equation-property}を証明せよ.
\end{exercise}

以上の議論より, $\LinEq$に対する局所的な検証として以下の検証者を考えることができる:
\begin{algorithm}{$\LinEq$に対する局所的な検証?}{local-verification-LinEq?}
  \begin{enumerate}
  \item 入力として$M,z$を受け取り, 証拠として$\pi \in \F^{q^n}$へのオラクルアクセスを受け取る.
  \item 一様ランダムな$r\sim\F^m$を選択し, $r^\top M$と$r^\top z$を計算する.
  \item 証拠$\pi\colon \F^{q^n}$を関数$\pi\colon \F^n\to \F$として解釈し, オラクルアクセスを用いて$a=\pi(M^\top r)$を求める.
  \item $a=r^\top z$ならば$1$を出力し, そうでなければ$0$を出力する.
  \end{enumerate}
\end{algorithm}

上記の検証者はPCP検証者の性質を持つだろうか?
まず, $(M,z)$がYesインスタンスであるとき, ある$y\in\F^n$が存在して$My=z$が成り立つ.
このとき, $\pi\colon\F^n\to\F$を$\pi(w)=y^\top w$とすると, $\pi(M^\top r)=y^\top (M^\top r)=r^\top (My)=r^\top z$となるため, 検証者は確率$1$で受理する.

一方で$(M,z)$がNoインスタンスであるときに検証者が拒否する確率はどうなるだろうか?
PCP検証者であることを示す(cf. \cref{def:PCP})には, 任意の$\pi\in\F^n\to\F$に対して拒否確率は少なくとも$1/3$以上でなければならない.
これは示せるのであろうか?
ある$y\in\F^n$に対して$\pi(w)=y^\top w$と表せるような$\pi\in\F^n\to\F$に対しては, \cref{eq:random-inner-product}の性質および$(M,z)$がNoインスタンスであることから$My\ne z$より, 少なくとも確率$1-1/q$で検証者は拒否する.
しかしながら, 一般の$\pi\in\F^n\to\F$はこのような線形関数として表現できるとは限らない.

\subsection{線形性テスト}
$\LinEq$に対するPCP検証者を構成するために,
\cref{alg:local-verification-LinEq?}を以下のように修正する:
オラクル$\pi$が, ある$y\in\F^n$に対して$\pi(w)=y^\top w$と表せるならば, \cref{alg:local-verification-LinEq?}のステップ2-4を実行し, そうでないならば$0$を出力する.
ここで新たに一つの問題が生じる: どのようにして$\pi$の線形性を局所検証すればよいだろうか?

一般にオラクルアクセスで与えられた関数$\pi\colon\F^n\to\F$が線形関数かどうかを厳密に確認するには,
\begin{align}
  \forall x,y\in\F^n,\quad \pi(x+y)=\pi(x)+\pi(y) \label{eq:linearity-test-all-points}
\end{align}
が成り立つかどうかを確認する必要があり, $q^n$回のオラクルアクセスが必要となってしまう.

そこで, 「線形関数であるかどうか」ではなく「線形関数に近いかどうか」を局所検証することを考える.
\begin{definition}{関数同士の近さ}{distance-between-functions}
  二つの関数$f,g\colon A \to B$に対して$\dist(f,g)$を
  \begin{align*}
    \dist(f,g) =\Pr_{a\sim A} \qty[ f(a) \ne g(a) ]
  \end{align*}
  と定義し, $\dist(f,g)\le\delta$を満たすとき, $f$は$g$に\emph{$\delta$-近い}($\delta$-close)という.
  
  また, 関数クラス$\calF\subseteq \qty{ g\colon A\to B }$および関数$f\colon A\to B$に対して
  \begin{align*}
    \dist(f,\calF) = \min_{g\in\calF} \dist(f,g)
  \end{align*}
  と定義し, $\delta(f,\calF)\le \delta$であるとき, $f$は$\calF$に$\delta$-近いという.
\end{definition}

関数$f\colon A\to B$をベクトル$f\in B^A$と同一視すると, $\dist(f,g)$はベクトル$f,g$間の正規化されたハミング距離($\ell_0$ノルム)に一致する.

関数クラス$\calF\subseteq \qty{ \rho\colon \F^n\to\F }$を線形関数全体, すなわち
\begin{align}
  \calF = \qty{ \rho\colon \F^n\ni x\mapsto y^\top x\in \F \colon y\in \F^n } \label{eq:linear-functions}
\end{align}
とする.
オラクルアクセスとして与えられた関数$\pi\colon \F^n\to\F$が$\calF$に近いかどうかを検証する局所検証者が構成できる \citet{BLR93}.

\begin{theorem}{線形性テスト}{linearity-test}
  関数クラス$\calF$を\cref{eq:linear-functions}で定義する.
  以下を満たす乱択多項式時間オラクルアルゴリズム$A^\pi(1^n)$が存在する\footnote{アルゴリズム$A$は$1^n$を入力として与えられているため, 多項式時間であることは計算量が$\poly(n)$で抑えられることを意味する.}:
  関数$\pi\colon \F^n\to\F$がオラクルアクセスとして与えられたとき,
  \begin{itemize}
    \item $\pi\in \calF$ならば$A^\pi(1^n)$は確率$1$で受理する.
    \item $\dist(\pi,\calF)\ge 0.01$ならば$A^\pi(1^n)$は確率$0.99$で拒否する.
  \end{itemize}
\end{theorem}
\begin{proof}
  アルゴリズム$A^\pi$は非常に単純で, 線形関数であることの特徴づけ\cref{eq:linearity-test-all-points}をランダムな点で確認するというものである.
  具体的には以下で与えられる:
  \begin{algorithm}{線形性テスト}{linearity-test}
    \begin{enumerate}
      \item オラクルアクセスとして関数$\pi\colon \F^n\to\F$を受け取り, 入力として$1^n$を受け取る.
      \item 一様ランダムに$x,y\sim\F^n$を選び, $\pi(x+y)\ne \pi(x)+\pi(y)$が成り立つならば拒否する.
      \item 十分大きな定数$K\in\Nat$に対し, ステップ2を$K$回繰り返す. この繰り返しの中で一度も拒否しなければ, 受理する.
    \end{enumerate}
  \end{algorithm}

  実際, $\pi\in\calF$ならば\cref{eq:linearity-test-all-points}が成り立つため, $A^\pi(1^n)$は確率$1$で受理する.
  一方で, $\dist(\pi,\calF)\ge 0.01$であるときに拒否確率を下から抑えたい.
  これは以下の主張から従う:

  \begin{claim}{線形性テストの拒否確率}{linearity-test-rejection-probability}
    任意の関数$\pi\colon \F^n\to\F$に対して
    \begin{align*}
      \Pr_{x,y\sim\F^n}\qty[ \pi(x+y) \ne \pi(x)+\pi(y) ] \ge \frac{1}{12}\cdot \dist(\pi,\calF).
    \end{align*}  
  \end{claim}

  \cref{claim:linearity-test-rejection-probability}は後で証明する.
  仮定より$\dist(\pi,\calF)\ge \delta:=0.01$なので,
  ステップ3の定数$K$を十分大きくすることによって, \cref{alg:linearity-test}の拒否確率を$0.99$より大きくすることができる.
  \end{proof}

  次に\cref{claim:linearity-test-rejection-probability}を示す.
  実際にはより一般的な次の補題を証明する.
  \begin{lemma}{準同型性テスト}{homomorphism-test}
    有限アーベル群$G,H$に対し, 写像$f\colon G\to H$が準同型であるとは, 任意の$x,y\in G$に対して$f(x+y)=f(x)+f(y)$が成り立つことをいい,
    準同型な写像の全体を$\mathrm{Hom}(G,H)$と表す.
    このとき, 任意の関数$f\colon G\to H$に対して
    \begin{align*}
      \Pr_{x,y\sim G}\qty[ f(x+y)\ne f(x)+f(y) ] \ge \frac{1}{12}\cdot \dist(f,\mathrm{Hom}(G,H)).
    \end{align*}
  \end{lemma}
  \begin{proof}
    記号の簡単のため, $\rho_f:=\Pr_{x,y\sim G}\qty[ f(x+y)\ne f(x)+f(y) ]$と表す.
    また, 各$y\in G$に対し, 写像$v_y\colon G\to H$を$v_y(x)=f(x+y)-f(y)$とし, $v\colon G\to H$を
    \begin{align*}
      v(x) = \mathrm{argmax}_{a \in H} \qty{ \Pr_{y\sim G}\qty[ v_y(x)=a ] }
    \end{align*}
    で定める (タイが存在する場合は任意).
    すなわち, $v(x)$は$(v_y(x))_{y\in G}$の中での多数決, すなわち最も出現頻度の高い値として定める.
    
  \end{proof}

\subsection{線形方程式の局所的な検証(2/2)}
ここまでの議論を用いて$\LinEq$に対する局所的な検証者を構成する.
\begin{algorithm}{$\LinEq$に対する局所的な検証}{local-verification-LinEq}
  \begin{enumerate}
    \item 入力として$M,z$を受け取り, 証拠として$\pi \in \F^{q^n}$へのオラクルアクセスを受け取る.
    \item \cref{thm:linearity-test}のアルゴリズムを$\pi$をオラクルとして実行し, $\dist(\pi,\calF)\ge 0.01$ならば拒否して終了する.
    \item 一様ランダムな$r\sim\F^m$を選択し, $r^\top M$と$r^\top z$を計算する.
    \item 新たに一様ランダムなベクトル$r'\sim\F^n$を選び, オラクルアクセスを用いて$a=\pi(M^\top r + r') - \pi(r')$を求める.
  \end{enumerate}
\end{algorithm}





\section{弱いPCP定理とその証明}
本節では以下の弱いPCP定理を証明する.
\begin{theorem}{弱いPCP定理}{weak-PCP-theorem}
  ある$r(n)=\poly(n),q(n)=O(1)$に対して, $\NP \subseteq \PCP(r,q)$が成り立つ.
\end{theorem}

我々の最終的な目標であるPCP定理(\cref{thm:PCPtheorem})では, PCP検証者のランダムビットの長さが$r(n)=O(\log n)$であることを要求しているため, $r(n)$に関しては\cref{thm:weak-PCP-theorem}は指数的に大きい値になってしまっているが, 読み込む証明の文字数は$n$に依存しない定数で抑えられるという点では同一である.
なお, \cref{thm:weak-PCP-theorem}は後に\cref{thm:PCPtheorem}の証明でも用いられる.

\begin{proof}
  NP完全な判定問題として3彩色問題$\ThreeCOL$を考え, ある$r=O(1),q=\poly(n)$に対して$\ThreeCOL\in\PCP(r,q)$を示す.
  すると, \cref{thm:weak-PCP-theorem}の証明は\cref{exer:exercise2}と同じ議論から得られる.

  3彩色問題$\ThreeCOL$のインスタンス$G=(V,E)$を考える.
  以降, $\F_3$を$\F$と略記する.
  これがYesインスタンスであることと, ある$x=(x(u))_{u\in V}\in\F^V$が存在して
  \begin{align}
    \forall e=\{u,v\}\in E, \quad (x(u) - x(v))^2 = 1 \label{eq:3-coloring-F3}
  \end{align}
  を満たすことは同値である. 従って, 二次方程式系\cref{eq:3-coloring-F3}に対する所望のPCP検証者を構成すればよい.
  まずはこの二次方程式系を線型方程式系として表現するために, 以下の行列$M \in \F^{E \times V^2}$を定義する:
  \begin{align*}
    M(e, (u,v)) = \begin{cases}
      1 & \text{if } u=v\in e,\\
      -2 & \text{if } e=\{u,v\},\\
      0 & \text{otherwise}.
    \end{cases}
  \end{align*}
  ベクトル$x\in\F^V$に対して$y\in\F^{V^2}$を$y(u,v)=x(u)\cdot x(v)$と定義する (特に$u=v$ならば$y(u,u)=x(u)^2$である).
  このとき, \cref{eq:3-coloring-F3}は$My=\allone$と表現できる.
  ここまでの議論から, $G=(V,E)$がYesインスタンスであることと, ある$y\in \F^{V^2}$が存在して
  \begin{enumerate}
    \item ある$x\in\F^V$が存在して, 全ての$u,v\in V^2$に対し$y(u,v)=x(u)\cdot x(v)$.
    \item $My=\allone$.
  \end{enumerate}
  を満たすことは同値である.
  従って, この二つの条件を検証するPCP検証者を構成すればよい.
  
  

\end{proof}

